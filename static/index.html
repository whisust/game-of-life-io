<!DOCTYPE html>
<html>
<head>
    <title>Game of Life Multiplayer</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }

        #gameCanvas {
            border: 2px solid #333;
            cursor: crosshair;
            display: block;
            margin: 20px auto;
            background-color: #000;
            image-rendering: pixelated; /* Pour un rendu net des pixels */
        }

        .controls {
            margin: 20px 0;
            text-align: center;
        }

        button {
            margin: 5px;
            padding: 12px 16px;
            border: 2px solid #007acc;
            background-color: white;
            color: #007acc;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        button:hover {
            background-color: #007acc;
            color: white;
        }

        .selected {
            background-color: #007acc !important;
            color: white !important;
            font-weight: bold;
        }

        .info {
            margin: 10px 0;
            text-align: center;
            font-size: 16px;
            padding: 10px;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #status {
            font-weight: bold;
        }

        .instructions {
            margin: 20px auto;
            max-width: 600px;
            padding: 15px;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .instructions h3 {
            margin-top: 0;
            color: #333;
        }

        .instructions ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .instructions li {
            margin: 5px 0;
        }

        .pattern-info {
            margin: 10px 0;
            font-style: italic;
            color: #666;
        }
    </style>
</head>
<body>
<h1>üß¨ Game of Life Multijoueur</h1>

<div class="info">
    <span id="status">D√©connect√©</span> |
    G√©n√©ration: <span id="generation">0</span> |
    Joueurs: <span id="players">0</span>
</div>

<div class="controls">
    <button class="pattern-btn" onclick="selectPattern('glider')" title="Raccourci: 1">
        üöÄ Glider
    </button>
    <button class="pattern-btn" onclick="selectPattern('oscillator')" title="Raccourci: 2">
        ‚ö° Oscillateur
    </button>
    <button class="pattern-btn" onclick="selectPattern('spaceship')" title="Raccourci: 3">
        üõ∏ Vaisseau
    </button>
    <button class="pattern-btn" onclick="selectPattern('block')" title="Raccourci: 4">
        ‚¨ú Block
    </button>
    <div class="pattern-info">
        Pattern s√©lectionn√©: <strong><span id="selectedPattern">glider</span></strong>
    </div>
    <div class="orientation-controls">
        <label>Orientation:</label>
        <button class="orientation-btn" onclick="selectOrientation('up')" id="orientUp" title="Raccourci: ‚Üë">‚¨ÜÔ∏è Haut</button>
        <button class="orientation-btn" onclick="selectOrientation('right')" id="orientRight" title="Raccourci: ‚Üí">‚û°Ô∏è Droite</button>
        <button class="orientation-btn" onclick="selectOrientation('down')" id="orientDown" title="Raccourci: ‚Üì">‚¨áÔ∏è Bas</button>
        <button class="orientation-btn" onclick="selectOrientation('left')" id="orientLeft" title="Raccourci: ‚Üê">‚¨ÖÔ∏è Gauche</button>
        <div class="orientation-info">
            Orientation: <strong><span id="selectedOrientation">up</span></strong>
        </div>
    </div>
    <div class="grid-size-controls">
        <label>Taille de la grille:</label>
        <button class="grid-btn" onclick="setGridSize(512)" id="grid512">512x512</button>
        <button class="grid-btn" onclick="setGridSize(256)" id="grid256">256x256</button>
        <button class="grid-btn" onclick="setGridSize(128)" id="grid128">128x128</button>
    </div>
    <div class="game-controls">
        <button class="init-btn" onclick="initGame()" id="initBtn">üöÄ Initialize Game</button>
        <button class="reset-btn" onclick="resetGame()" id="resetBtn">üîÑ Reset Game</button>
    </div>
</div>

<canvas id="gameCanvas" width="512" height="512"></canvas>

<div class="instructions">
    <h3>üéÆ Comment jouer</h3>
    <ul>
        <li><strong>Cliquez</strong> sur la grille pour placer le pattern s√©lectionn√©</li>
        <li><strong>Touches 1-4</strong> pour changer rapidement de pattern</li>
        <li><strong>Touches fl√®ches</strong> (‚Üë, ‚Üí, ‚Üì, ‚Üê) pour changer l'orientation du pattern</li>
        <li><strong>Glider</strong> : Se d√©place en diagonal</li>
        <li><strong>Oscillateur</strong> : Alterne entre √©tats</li>
        <li><strong>Vaisseau</strong> : Se d√©place horizontalement</li>
        <li><strong>Block</strong> : Reste stable</li>
    </ul>
    <p><em>Le jeu √©volue automatiquement toutes les 250ms selon les r√®gles du Jeu de la Vie de Conway.</em></p>
</div>

<script>
    class GameOfLifeClient {
        constructor() {
            this.canvas = document.getElementById('gameCanvas');
            this.ctx = this.canvas.getContext('2d');
            this.ws = null;
            this.playerId = null;
            this.selectedPattern = 'glider';
            this.selectedOrientation = 'up'; // Default orientation
            this.gridSize = 128; // Default grid size
            this.canvasSize = 512; // Fixed canvas size
            this.cellSize = this.canvasSize / this.gridSize; // Calculate cell size based on grid size
            this.gameState = null;
            this.isConnected = false;

            this.setupCanvas();
            this.setupEventListeners();
            this.connect();

            // Highlight default grid size button
            document.getElementById(`grid${this.gridSize}`).classList.add('selected');
            // Highlight default orientation button
            document.getElementById('orientUp').classList.add('selected');
        }

        setupCanvas() {
            // Ajuster la taille d'affichage pour une meilleure visibilit√©
            this.canvas.style.width = '512px';
            this.canvas.style.height = '512px';
            this.canvas.width = 512;
            this.canvas.height = 512;

            // Canvas noir par d√©faut
            this.ctx.fillStyle = '#000000';
            this.ctx.fillRect(0, 0, 512, 512);
        }

        setupEventListeners() {
            this.canvas.addEventListener('click', (e) => {
                if (!this.isConnected || !this.playerId) return;

                const rect = this.canvas.getBoundingClientRect();
                const x = Math.floor((e.clientX - rect.left) * (this.gridSize / this.canvas.clientWidth));
                const y = Math.floor((e.clientY - rect.top) * (this.gridSize / this.canvas.clientHeight));

                this.placePattern(x, y);
            });

            // Emp√™cher le menu contextuel sur clic droit
            this.canvas.addEventListener('contextmenu', (e) => e.preventDefault());
        }

        setGridSize(size) {
            this.gridSize = size;
            this.cellSize = this.canvasSize / this.gridSize;

            // Update UI
            document.querySelectorAll('.grid-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            document.getElementById(`grid${size}`).classList.add('selected');

            // Re-render if we have game state
            if (this.gameState) {
                this.render();
            }
        }

        connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;

            this.ws = new WebSocket(wsUrl);

            this.ws.onopen = () => {
                console.log('Connexion WebSocket ouverte');
                this.updateStatus('Connexion...');

                // Rejoindre le jeu
                const playerName = prompt('Entrez votre nom:') || 'Anonyme';
                this.ws.send(JSON.stringify({
                    type: 'join',
                    name: playerName
                }));
            };

            this.ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                this.handleMessage(data);
            };

            this.ws.onclose = () => {
                console.log('Connexion WebSocket ferm√©e');
                this.isConnected = false;
                this.updateStatus('D√©connect√©');

                // Tentative de reconnexion apr√®s 3 secondes
                setTimeout(() => {
                    if (!this.isConnected) {
                        console.log('Tentative de reconnexion...');
                        this.connect();
                    }
                }, 3000);
            };

            this.ws.onerror = (error) => {
                console.error('Erreur WebSocket:', error);
                this.updateStatus('Erreur de connexion');
            };
        }

        handleMessage(data) {
            switch (data.type) {
                case 'joined':
                    this.playerId = data.player_id;
                    this.isConnected = true;
                    this.setGridSize(data.grid_size);
                    this.updateStatus('Connect√©');
                    console.log('Rejoint le jeu:', data.message);
                    break;

                case 'game_state':
                    this.gameState = data;
                    this.render();
                    this.updateUI();
                    break;

                case 'game_initialized':
                    console.log('Game has been initialized:', data.message);
                    this.setGridSize(data.grid_size);
                    document.getElementById('generation').textContent = '0';
                    document.getElementById('players').textContent = data.players_count;
                    break;

                case 'game_reset':
                    console.log('Game has been reset:', data.message);
                    this.setGridSize(data.grid_size);
                    document.getElementById('generation').textContent = '0';
                    document.getElementById('players').textContent = data.players_count;
                    break;

                default:
                    console.log('Message non g√©r√©:', data);
            }
        }

        placePattern(x, y) {
            if (!this.ws || this.ws.readyState !== WebSocket.OPEN) return;

            this.ws.send(JSON.stringify({
                type: 'place_pattern',
                pattern: this.selectedPattern,
                orientation: this.selectedOrientation,
                x: x,
                y: y
            }));
        }

        initGame() {
            if (!this.ws || this.ws.readyState !== WebSocket.OPEN) return;

            this.ws.send(JSON.stringify({
                type: 'init_game',
                grid_size: this.gridSize
            }));
            console.log(`Initialize game command sent with grid size ${this.gridSize}`);
        }

        resetGame() {
            if (!this.ws || this.ws.readyState !== WebSocket.OPEN) return;

            this.ws.send(JSON.stringify({
                type: 'reset_game',
                grid_size: this.gridSize
            }));
            console.log('Reset game command sent');
        }

        selectOrientation(orientation) {
            this.selectedOrientation = orientation;
            document.getElementById('selectedOrientation').textContent = orientation;

            // Update visual indication of selected orientation
            document.querySelectorAll('.orientation-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            document.getElementById(`orient${orientation.charAt(0).toUpperCase() + orientation.slice(1)}`).classList.add('selected');
        }

        render() {
            if (!this.gameState) return;

            // Clear the canvas
            this.ctx.fillStyle = '#000000';
            this.ctx.fillRect(0, 0, this.canvasSize, this.canvasSize);

            // Set cell color
            this.ctx.fillStyle = '#FFFFFF';

            // Draw cells based on cell size
            for (let y = 0; y < this.gridSize; y++) {
                for (let x = 0; x < this.gridSize; x++) {
                    const isAlive = this.gameState.grid[y][x];

                    if (isAlive) {
                        // Calculate position based on cell size
                        const pixelX = x * this.cellSize;
                        const pixelY = y * this.cellSize;

                        // Draw the cell
                        this.ctx.fillRect(pixelX, pixelY, this.cellSize, this.cellSize);
                    }
                }
            }
        }

        updateUI() {
            if (!this.gameState) return;

            document.getElementById('generation').textContent = this.gameState.generation;
            document.getElementById('players').textContent = this.gameState.players_count;
        }

        updateStatus(status) {
            document.getElementById('status').textContent = status;

            // Couleur selon le statut
            const statusEl = document.getElementById('status');
            statusEl.style.color = this.isConnected ? '#00aa00' : '#aa0000';
        }

        selectPattern(pattern) {
            this.selectedPattern = pattern;
            document.getElementById('selectedPattern').textContent = pattern;

            // Mise √† jour visuelle des boutons
            document.querySelectorAll('.pattern-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            console.log(pattern);

            // Add selected class to the button for the selected pattern
            // Use a more reliable selector based on the pattern name
            document.querySelector(`.pattern-btn[onclick*="selectPattern('${pattern}')"]`).classList.add('selected');
        }
    }

    // Fonction globale pour la s√©lection de pattern
    function selectPattern(pattern) {
        if (window.gameClient) {
            window.gameClient.selectPattern(pattern);
        }
    }

    // Fonction globale pour la s√©lection d'orientation
    function selectOrientation(orientation) {
        if (window.gameClient) {
            window.gameClient.selectOrientation(orientation);
        }
    }

    // Fonction globale pour changer la taille de la grille
    function setGridSize(size) {
        if (window.gameClient) {
            window.gameClient.setGridSize(size);
        }
    }

    // Fonction globale pour initialiser le jeu
    function initGame() {
        if (window.gameClient) {
            window.gameClient.initGame();
        }
    }

    // Fonction globale pour r√©initialiser le jeu
    function resetGame() {
        if (window.gameClient) {
            window.gameClient.resetGame();
        }
    }

    // Initialiser le client au chargement de la page
    window.addEventListener('DOMContentLoaded', () => {
        window.gameClient = new GameOfLifeClient();

        // S√©lectionner le premier pattern par d√©faut
        setTimeout(() => {
            document.querySelector('.pattern-btn').click();
        }, 100);
    });

    // Gestion des raccourcis clavier
    document.addEventListener('keydown', (e) => {
        if (!window.gameClient) return;

        switch(e.key) {
            // Pattern selection
            case '1':
                selectPattern('glider');
                break;
            case '2':
                selectPattern('oscillator');
                break;
            case '3':
                selectPattern('spaceship');
                break;
            case '4':
                selectPattern('block');
                break;

            // Orientation selection with arrow keys
            case 'ArrowUp':
                selectOrientation('up');
                e.preventDefault(); // Prevent page scrolling
                break;
            case 'ArrowRight':
                selectOrientation('right');
                e.preventDefault();
                break;
            case 'ArrowDown':
                selectOrientation('down');
                e.preventDefault();
                break;
            case 'ArrowLeft':
                selectOrientation('left');
                e.preventDefault();
                break;
        }
    });
</script>
</body>
</html>
